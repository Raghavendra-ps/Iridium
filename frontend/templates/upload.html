{% extends "dashboard_base.html" %} {% block title %}New Conversion - Gretis
DataPort{% endblock %} {% block content %}
<div class="card">
    <h1 class="card-title">Step 1: Upload a File for Analysis</h1>
    <p style="margin-bottom: 1.5rem; color: var(--color-text-muted)">
        Select the attendance period and the source file to begin the
        intelligent analysis process.
    </p>
    <form
        id="analysisForm"
        style="display: flex; flex-direction: column; gap: 1.5rem"
    >
        <!-- 1. Attendance Period -->
        <div
            id="attendance-period-group"
            style="display: grid; gap: 1.5rem; grid-template-columns: 1fr 1fr"
        >
            <div class="form-group">
                <label
                    for="attendance_year"
                    style="display: block; margin-bottom: 8px; font-weight: 500"
                    >Attendance Year</label
                >
                <select
                    id="attendance_year"
                    name="attendance_year"
                    required
                    style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid var(--color-border);
                        border-radius: 8px;
                        background-color: white;
                    "
                ></select>
            </div>
            <div class="form-group">
                <label
                    for="attendance_month"
                    style="display: block; margin-bottom: 8px; font-weight: 500"
                    >Attendance Month</label
                >
                <select
                    id="attendance_month"
                    name="attendance_month"
                    required
                    style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid var(--color-border);
                        border-radius: 8px;
                        background-color: white;
                    "
                ></select>
            </div>
        </div>

        <!-- 2. File Input -->
        <div class="form-group">
            <label
                for="fileInput"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >Source File</label
            >
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px">
                Supported: Excel (.xlsx, .xls), CSV.
            </div>
            <input
                type="file"
                id="fileInput"
                name="file"
                required
                accept=".xlsx,.xls,.csv"
                style="
                    width: 100%;
                    padding: 10px;
                    border: 1px solid var(--color-border);
                    border-radius: 8px;
                "
            />
        </div>

        <!-- 3. Actions -->
        <div
            style="
                display: flex;
                justify-content: flex-end;
                align-items: center;
                gap: 1rem;
            "
        >
            <div id="statusMessage" style="font-size: 0.9rem"></div>
            <button
                type="submit"
                class="btn"
                style="
                    background-color: var(--color-accent);
                    color: white;
                    font-size: 1rem;
                    padding: 12px 24px;
                "
            >
                Analyze File
            </button>
        </div>
    </form>
</div>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("access_token");
        if (!token) {
            window.location.href = "/login";
            return;
        }

        const yearSelect = document.getElementById("attendance_year");
        const monthSelect = document.getElementById("attendance_month");
        const analysisForm = document.getElementById("analysisForm");
        const statusMessage = document.getElementById("statusMessage");
        const submitButton = analysisForm.querySelector(
            'button[type="submit"]',
        );

        // --- Populate Date Dropdowns ---
        const currentYear = new Date().getFullYear();
        for (let i = -2; i <= 2; i++) {
            // Show a range of 5 years
            const year = currentYear + i;
            yearSelect.add(new Option(year, year));
        }
        yearSelect.value = currentYear;

        const months = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];
        months.forEach((month, index) =>
            monthSelect.add(new Option(month, index + 1)),
        );
        monthSelect.value = new Date().getMonth() + 1;

        // --- Form Submission Logic ---
        analysisForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            if (!analysisForm.checkValidity()) {
                showStatus("Please fill out all fields.", "error");
                return;
            }

            const formData = new FormData(analysisForm);
            submitButton.disabled = true;
            submitButton.textContent = "Analyzing...";
            showStatus("Uploading and analyzing file, please wait...", "info");

            try {
                const response = await fetch(
                    "/api/v1/conversions/upload-for-analysis",
                    {
                        method: "POST",
                        headers: { Authorization: `Bearer ${token}` },
                        body: formData,
                    },
                );

                const data = await response.json();
                if (response.ok) {
                    // Store the analysis results in session storage to pass to the next page
                    sessionStorage.setItem(
                        "analysisResult",
                        JSON.stringify(data),
                    );

                    // Also pass along the selected year and month
                    const year = yearSelect.value;
                    const month = monthSelect.value;
                    sessionStorage.setItem(
                        "attendancePeriod",
                        JSON.stringify({ year, month }),
                    );

                    // Redirect to the new confirmation page
                    window.location.href = `/jobs/${data.job_id}/configure`;
                } else {
                    throw new Error(data.detail || "File analysis failed.");
                }
            } catch (error) {
                showStatus(error.message, "error");
                submitButton.disabled = false;
                submitButton.textContent = "Analyze File";
            }
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.style.color =
                type === "error"
                    ? "red"
                    : type === "success"
                      ? "green"
                      : "#333";
        }
    });
</script>
{% endblock %}
