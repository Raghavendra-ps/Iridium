<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Iridium{% endblock %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        :root {
            --color-primary: #0f172a; --color-accent: #2563eb; --color-border: #e2e8f0;
            --color-text: #0f172a; --color-text-muted: #64748b; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --radius-lg: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Inter", sans-serif; background: #f8fafc; color: #334155; }
        a { color: var(--color-accent); text-decoration: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 16px 0;
            background: white; position: sticky; top: 0; z-index: 10;
        }
        .header-brand { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .header-title { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .user-info { color: var(--color-text-muted); }
        .btn {
            padding: 8px 16px; border: 1px solid var(--color-border); border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: background-color 0.2s;
            text-decoration: none; color: #334155; background-color: #fff;
            display: inline-flex; align-items: center; font-size: 0.9rem;
        }
        .btn:hover { background-color: #f1f5f9; }
        .btn-danger { background-color: #ef4444; color: white; border-color: transparent; }
        .btn-danger:hover { background-color: #dc2626; }
        .dashboard-layout { display: flex; gap: 24px; padding-top: 24px; align-items: flex-start; }
        .sidebar { width: 260px; flex-shrink: 0; }
        .main-content { flex-grow: 1; }
        .nav-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .nav-list a { display: block; padding: 12px 16px; border-radius: 8px; text-decoration: none; font-weight: 500; color: #334155; }
        .nav-list a:hover { background-color: #e2e8f0; }
        .nav-list a.active { background-color: var(--color-primary); color: white; }
        .card { background: white; border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--color-text); margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div style="background: white; border-bottom: 1px solid var(--color-border);">
        <div class="container">
            <header class="header">
                <a href="/home" class="header-brand"><span class="header-title">Iridium</span></a>
                <div class="header-actions">
                    <div class="user-info">Logged in as: <strong id="user-email">...</strong></div>
                    <a href="/settings" class="btn">Settings</a>
                    <button id="logoutBtn" class="btn btn-danger">Logout</button>
                </div>
            </header>
        </div>
    </div>
    <div class="container">
        <div class="dashboard-layout">
            <aside class="sidebar">
                <nav><ul class="nav-list">
                    <li><a href="/home" class="{% if active_page == 'home' %}active{% endif %}">Home</a></li>
                    <li><a href="/upload" class="{% if active_page == 'upload' %}active{% endif %}">New Conversion</a></li>
                    <li><a href="/jobs" class="{% if active_page == 'jobs' %}active{% endif %}">My Jobs</a></li>
                </ul></nav>
            </aside>
            <main class="main-content">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script>
    // This is the single, centralized script for the entire dashboard.
    document.addEventListener('DOMContentLoaded', async function () {
        const token = localStorage.getItem('access_token');
        const userEmailElement = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logoutBtn');

        // Step 1: Authenticate the user. This runs on every dashboard page.
        if (!token) {
            window.location.href = '/login';
            return;
        }
        try {
            const userResponse = await fetch('/api/v1/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!userResponse.ok) {
                // If token is invalid, clear it and redirect to login
                localStorage.removeItem('access_token');
                window.location.href = '/login';
                return;
            }
            const userData = await userResponse.json();
            userEmailElement.textContent = userData.email;
        } catch (e) {
            // If the server is down, redirect to login
            window.location.href = '/login';
            return;
        }

        // Step 2: Bind global event listeners like the logout button.
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        });

        // Step 3: Check if the specific page (e.g., job_detail.html) has defined
        // its own startup logic, and if so, run it.
        if (typeof onPageLoad === 'function') {
            onPageLoad(token);
        }
    });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
