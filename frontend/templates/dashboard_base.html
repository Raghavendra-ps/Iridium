<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{% block title %}Dashboard{% endblock %}</title>
        
        <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
        <link rel="manifest" href="/static/site.webmanifest">
        <link rel="shortcut icon" href="/static/favicon.ico">
        
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
        <style>
            :root {
                --color-primary: #0f172a;
                --color-accent: #2563eb;
                --color-border: #e2e8f0;
                --color-text: #0f172a;
                --color-text-muted: #64748b;
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
                --radius-lg: 12px;
            }
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { 
                font-family: "Inter", sans-serif; 
                background: #f4f1eb; 
                color: #334155; 
            }
            a { color: var(--color-accent); text-decoration: none; }
            .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
            .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; background: white; position: sticky; top: 0; z-index: 10; }
            .header-brand { display: flex; align-items: center; gap: 12px; text-decoration: none; }
            .header-logo { height: 32px; }
            .header-actions { display: flex; align-items: center; gap: 16px; }
            .user-info { color: var(--color-text-muted); }
            .btn { padding: 8px 16px; border: 1px solid var(--color-border); border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; text-decoration: none; color: #334155; background-color: #fff; display: inline-flex; align-items: center; font-size: 0.9rem; }
            .btn:hover { background-color: #f1f5f9; }
            .btn-danger { background-color: #ef4444; color: white; border-color: transparent; }
            .btn-danger:hover { background-color: #dc2626; }
            .dashboard-layout { display: flex; gap: 24px; padding-top: 24px; align-items: flex-start; }
            .sidebar { width: 260px; flex-shrink: 0; }
            .main-content { flex-grow: 1; }
            .nav-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
            .nav-list a { display: block; padding: 12px 16px; border-radius: 8px; text-decoration: none; font-weight: 500; color: #334155; }
            .nav-list a:hover { background-color: #e2e8f0; }
            .nav-list a.active { background-color: var(--color-primary); color: white; }
            .card { background: white; border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
            .card-title { font-size: 1.25rem; font-weight: 600; color: var(--color-text); margin-bottom: 1rem; }
        </style>
    </head>
    <body>
        <div style="background: white; border-bottom: 1px solid var(--color-border);">
            <div class="container">
                <header class="header">
                    <a href="/home" class="header-brand">
                        <img src="/static/images/logo.svg" alt="Gretis Logo" class="header-logo">
                    </a>
                    <div class="header-actions">
                        <div class="user-info">Logged in as: <strong id="user-email">...</strong></div>
                        <a href="/settings" class="btn">Settings</a>
                        <button id="logoutBtn" class="btn btn-danger">Logout</button>
                    </div>
                </header>
            </div>
        </div>
        <div class="container">
            <div class="dashboard-layout">
                <aside class="sidebar">
                    <nav>
                        <ul class="nav-list">
                            <li id="home-nav-link" style="display: none;"><a href="/home" class="{% if active_page == 'home' %}active{% endif %}">Home</a></li>
                            <li id="upload-nav-link" style="display: none;"><a href="/upload" class="{% if active_page == 'upload' %}active{% endif %}">New Conversion</a></li>
                            <li id="jobs-nav-link" style="display: none;"><a href="/jobs" class="{% if active_page == 'jobs' %}active{% endif %}">My Jobs</a></li>
                            <li id="sheet-maker-nav-link" style="display: none;"><a href="/sheet-maker" class="{% if active_page == 'sheet-maker' %}active{% endif %}">Sheet Generator</a></li>
                            
                            <!-- Admin Section Separator -->
                            <div id="admin-section-divider" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border);"></div>
                            
                            <li id="org-nav-link" style="display: none;">
                                <a href="/organizations" class="{% if active_page == 'organizations' %}active{% endif %}">Organizations</a>
                            </li>
                            <li id="admin-nav-link" style="display: none;">
                                <a href="/admin" class="{% if active_page == 'admin' %}active{% endif %}">User Management</a>
                            </li>
                        </ul>
                    </nav>
                </aside>
                <main class="main-content">
                    {% block content %}{% endblock %}
                </main>
            </div>
        </div>

        <script>
            let currentUser = null;

            document.addEventListener("DOMContentLoaded", async function () {
                const token = localStorage.getItem("access_token");
                if (!token) {
                    window.location.href = "/login";
                    return;
                }

                try {
                    const userResponse = await fetch("/api/v1/users/me", {
                        headers: { Authorization: `Bearer ${token}` },
                    });
                    if (!userResponse.ok) {
                        localStorage.removeItem("access_token");
                        window.location.href = "/login";
                        return;
                    }
                    const userData = await userResponse.json();
                    currentUser = userData;

                    const userEmailElement = document.getElementById("user-email");
                    if (userEmailElement) {
                        userEmailElement.textContent = userData.email;
                    }
                    
                    const userRole = userData.role;
                    const navLinks = {
                        home: document.getElementById("home-nav-link"),
                        upload: document.getElementById("upload-nav-link"),
                        jobs: document.getElementById("jobs-nav-link"),
                        sheetMaker: document.getElementById("sheet-maker-nav-link"),
                        admin: document.getElementById("admin-nav-link"),
                        organizations: document.getElementById("org-nav-link"), // New link
                        adminDivider: document.getElementById("admin-section-divider"), // Divider
                    };

                    // Updated role permissions
                    const permissions = {
                        superadmin: ['home', 'upload', 'jobs', 'sheetMaker', 'admin', 'organizations', 'adminDivider'],
                        employee: ['home', 'upload', 'jobs', 'sheetMaker'],
                        manager: ['home', 'jobs'] // Changed 'client' to 'manager'
                    };

                    const allowedLinks = permissions[userRole] || [];
                    for (const [linkName, element] of Object.entries(navLinks)) {
                        if (element && allowedLinks.includes(linkName)) {
                            element.style.display = 'block';
                        }
                    }

                } catch (e) {
                    localStorage.removeItem("access_token");
                    window.location.href = "/login";
                    return;
                }

                const logoutBtn = document.getElementById("logoutBtn");
                if(logoutBtn) {
                    logoutBtn.addEventListener("click", () => {
                        localStorage.removeItem("access_token");
                        window.location.href = "/login";
                    });
                }

                if (typeof onPageLoad === "function") {
                    onPageLoad(token, currentUser);
                }
            });
        </script>

        {% block scripts %}{% endblock %}
    </body>
</html>