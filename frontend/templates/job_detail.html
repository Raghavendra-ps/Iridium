{% extends "dashboard_base.html" %} {% block title %}Job #{{ job_id }}{% endblock %} {% block content %}
<!-- This main container allows us to override the layout for this page only -->
<div id="job-detail-page" data-job-id="{{ job_id }}"></div>
<div id="job-detail-container">
    <!-- Header -->
    <div class="card" style="margin-bottom: 20px">
        <div
            style="
                display: flex;
                justify-content: space-between;
                align-items: center;
            "
        >
            <div style="display: flex; align-items: center; gap: 1rem">
                <button
                    id="back-to-home-btn"
                    class="back-btn"
                    title="Back to Dashboard"
                >
                    ← Back
                </button>
                <div>
                    <h1 id="job-title" class="card-title">
                        Loading Job #{{ job_id }}...
                    </h1>
                    <p id="job-subtitle" style="color: var(--color-text-muted)">
                        Fetching details...
                    </p>
                </div>
            </div>
            <div id="job-status-badge" class="status-badge">LOADING</div>
        </div>
    </div>

    <!-- Submission Error Panel (initially hidden) -->
    <div
        id="submission-error-panel"
        class="card"
        style="
            display: none;
            border-color: #fca5a5;
            background-color: #fff1f2;
            margin-bottom: 20px;
        "
    >
        <h2 class="card-title" style="color: #b91c1c">Submission Failed</h2>
        <p
            id="submission-error-summary"
            style="margin-bottom: 1rem; color: #b91c1c"
        ></p>
        <div
            id="submission-error-details"
            style="
                max-height: 200px;
                overflow-y: auto;
                background: white;
                padding: 1rem;
                border-radius: 8px;
            "
        ></div>
    </div>

    <!-- Quick Stats Dashboard -->
    <div
        id="stats-dashboard"
        class="card"
        style="margin-bottom: 20px; display: none"
    >
        <div
            style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1.5rem;
            "
        >
            <div class="stat-card">
                <div id="stat-total-records" class="stat-value">-</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div id="stat-employee-count" class="stat-value">-</div>
                <div class="stat-label">Employees Affected</div>
            </div>
            <div class="stat-card">
                <div
                    id="stat-present-count"
                    class="stat-value"
                    style="color: #059669"
                >
                    -
                </div>
                <div class="stat-label">Present</div>
            </div>
            <div class="stat-card">
                <div
                    id="stat-absent-count"
                    class="stat-value"
                    style="color: #dc2626"
                >
                    -
                </div>
                <div class="stat-label">Absent</div>
            </div>
            <div class="stat-card">
                <div
                    id="stat-leave-count"
                    class="stat-value"
                    style="color: #2563eb"
                >
                    -
                </div>
                <div class="stat-label">On Leave</div>
            </div>
            <div class="stat-card">
                <div
                    id="stat-halfday-count"
                    class="stat-value"
                    style="color: #f59e0b"
                >
                    -
                </div>
                <div class="stat-label">Half Day</div>
            </div>
        </div>
    </div>

    <!-- Data Validation Section -->
    <div class="card">
        <!-- Tabs -->
        <div
            style="
                display: flex;
                border-bottom: 1px solid var(--color-border);
                margin-bottom: 1.5rem;
            "
        >
            <button id="tab-processed" class="tab-btn active">
                Validation Grid (Editable)
            </button>
            <button id="tab-raw" class="tab-btn">
                Raw Extracted Data (Read-only)
            </button>
        </div>

        <!-- Toolbar for Grid Controls -->
        <div class="grid-toolbar">
            <div class="toolbar-group">
                <label
                    for="search-field"
                    style="font-size: 0.9rem; color: #666; margin-right: 8px"
                    >Search:</label
                >
                <input
                    type="search"
                    id="search-field"
                    placeholder="Search data..."
                    class="toolbar-input"
                />
            </div>
            <button
                id="fullscreen-btn"
                class="toolbar-btn"
                title="Toggle Fullscreen"
            >
                ⛶
            </button>
        </div>

        <!-- Processed and Raw Data Views -->
        <div id="view-processed">
            <div
                id="processed-data-grid"
                style="
                    width: 100%;
                    height: 60vh;
                    overflow: hidden;
                    border: 1px solid #e2e8f0;
                    font-size: 14px;
                "
            ></div>
            <div
                id="actions-bar"
                style="
                    margin-top: 1.5rem;
                    display: none;
                    justify-content: flex-end;
                    gap: 1rem;
                "
            >
                <button
                    id="submitBtn"
                    class="btn"
                    style="background-color: var(--color-accent); color: white"
                >
                    Submit Records to ERPNext
                </button>
            </div>
        </div>
        <div id="view-raw" style="display: none">
            <div
                id="raw-data-grid"
                style="
                    width: 100%;
                    height: 60vh;
                    overflow: hidden;
                    border: 1px solid #e2e8f0;
                    font-size: 14px;
                "
            ></div>
        </div>
    </div>
</div>

<style>
    /* --- Page Layout Override --- */
    .dashboard-layout {
        gap: 0;
    }
    .sidebar {
        display: none;
    }
    .main-content {
        width: 100%;
        max-width: 100%;
    }

    /* --- Back Button --- */
    .back-btn {
        padding: 8px 16px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        background-color: #fff;
        color: var(--color-text);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition:
            background-color 0.2s,
            border-color 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .back-btn:hover {
        background-color: #f1f5f9;
        border-color: var(--color-accent);
    }

    /* --- Status Badge & Stats --- */
    .status-badge {
        background: #eee;
        padding: 6px 12px;
        border-radius: 99px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .stat-card {
        border: 1px solid var(--color-border);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        text-align: center;
        background: #fff;
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--color-primary);
        line-height: 1;
    }
    .stat-label {
        color: var(--color-text-muted);
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    /* --- Tab Styles --- */
    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        color: var(--color-text-muted);
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition:
            color 0.2s,
            border-color 0.2s;
    }
    .tab-btn:hover {
        color: var(--color-accent);
    }
    .tab-btn.active {
        color: var(--color-accent);
        border-bottom-color: var(--color-accent);
    }

    /* --- Toolbar Styles --- */
    .grid-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
        margin-bottom: 1rem;
    }
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .toolbar-input {
        padding: 6px 10px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 200px;
    }
    .toolbar-input:focus {
        outline: 2px solid var(--color-accent);
        outline-offset: -1px;
    }
    .toolbar-btn {
        font-size: 1.2rem;
        font-weight: bold;
        width: 32px;
        height: 32px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .toolbar-btn:hover {
        background-color: #f1f5f9;
    }

    /* --- Handsontable Overrides --- */
    .ht_clone_left {
        z-index: 101 !important;
    }
    .ht_clone_top {
        z-index: 102 !important;
    }
    .ht_clone_top_left_corner {
        z-index: 103 !important;
    }
    .htDropdownMenu {
        z-index: 200 !important;
    }

    /* --- Attendance Status Colors --- */
    .status-present {
        background-color: #d1fae5 !important;
        color: #065f46 !important;
        font-weight: 500;
    }
    .status-absent {
        background-color: #fee2e2 !important;
        color: #991b1b !important;
        font-weight: 500;
    }
    .status-leave {
        background-color: #dbeafe !important;
        color: #1e40af !important;
        font-weight: 500;
    }
    .status-halfday {
        background-color: #fed7aa !important;
        color: #92400e !important;
        font-weight: 500;
    }
</style>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("access_token");
        if (!token) {
            window.location.href = "/login";
            return;
        }

        const jobId = document.getElementById("job-detail-page").dataset.jobId;

        // --- UI Elements ---
        const elTitle = document.getElementById("job-title");
        const elSubtitle = document.getElementById("job-subtitle");
        const elBadge = document.getElementById("job-status-badge");
        const elActions = document.getElementById("actions-bar");
        const btnSubmit = document.getElementById("submitBtn");
        const btnBackToHome = document.getElementById("back-to-home-btn");
        const tabProcessed = document.getElementById("tab-processed");
        const tabRaw = document.getElementById("tab-raw");
        const viewProcessed = document.getElementById("view-processed");
        const viewRaw = document.getElementById("view-raw");
        const gridProcessedContainer = document.getElementById(
            "processed-data-grid",
        );
        const gridRawContainer = document.getElementById("raw-data-grid");
        const searchField = document.getElementById("search-field");
        const fullscreenBtn = document.getElementById("fullscreen-btn");
        const errorPanel = document.getElementById("submission-error-panel");
        const errorSummary = document.getElementById(
            "submission-error-summary",
        );
        const errorDetails = document.getElementById(
            "submission-error-details",
        );
        const statsDashboard = document.getElementById("stats-dashboard");
        const statTotalRecords = document.getElementById("stat-total-records");
        const statEmployeeCount = document.getElementById(
            "stat-employee-count",
        );
        const statPresentCount = document.getElementById("stat-present-count");
        const statAbsentCount = document.getElementById("stat-absent-count");
        const statLeaveCount = document.getElementById("stat-leave-count");
        const statHalfDayCount = document.getElementById("stat-halfday-count");

        let hotProcessed, hotRaw;
        let currentJobData = null;

        const apiCall = (url) =>
            fetch(url, { headers: { Authorization: `Bearer ${token}` } });

        // --- Back to Home Button ---
        btnBackToHome.addEventListener("click", () => {
            window.location.href = "/home";
        });

        // --- Cell Renderer for Status Colors ---
        function statusRenderer(
            instance,
            td,
            row,
            col,
            prop,
            value,
            cellProperties,
        ) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            td.classList.remove(
                "status-present",
                "status-absent",
                "status-leave",
                "status-halfday",
            );

            if (value) {
                const val = value.toString().toLowerCase();
                if (val === "present") {
                    td.classList.add("status-present");
                } else if (val === "absent") {
                    td.classList.add("status-absent");
                } else if (val === "on leave") {
                    td.classList.add("status-leave");
                } else if (val === "half day") {
                    td.classList.add("status-halfday");
                }
            }
            return td;
        }

        // --- Toolbar & UI Logic ---
        searchField.addEventListener("keyup", (event) => {
            const currentGrid =
                viewProcessed.style.display !== "none" ? hotProcessed : hotRaw;
            if (currentGrid) {
                const search = currentGrid.getPlugin("search");
                if (search) {
                    search.query(event.target.value);
                    currentGrid.render();
                }
            }
        });

        fullscreenBtn.addEventListener("click", () => {
            const container = document.querySelector(
                "#job-detail-container .card:last-of-type",
            );
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch((err) => {
                    console.error("Fullscreen error:", err);
                    alert(
                        `Error attempting to enable full-screen mode: ${err.message}`,
                    );
                });
            } else {
                document.exitFullscreen();
            }
        });

        // --- Tab Switching Logic ---
        tabProcessed.addEventListener("click", () => {
            tabProcessed.classList.add("active");
            tabRaw.classList.remove("active");
            viewProcessed.style.display = "block";
            viewRaw.style.display = "none";
            if (hotProcessed) hotProcessed.render();
        });

        tabRaw.addEventListener("click", () => {
            tabRaw.classList.add("active");
            tabProcessed.classList.remove("active");
            viewRaw.style.display = "block";
            viewProcessed.style.display = "none";
            if (!hotRaw) {
                loadRawGrid();
            } else {
                hotRaw.render();
            }
        });

        // --- Stats Calculation ---
        function updateStatsDashboard(records) {
            if (!records || records.length === 0) {
                statsDashboard.style.display = "none";
                return;
            }

            statTotalRecords.textContent = records.length;

            const uniqueEmployees = new Set(
                records.map((r) => r.employee).filter((e) => e),
            );
            statEmployeeCount.textContent = uniqueEmployees.size;

            const statusCounts = records.reduce((acc, record) => {
                if (record.status) {
                    acc[record.status] = (acc[record.status] || 0) + 1;
                }
                return acc;
            }, {});

            statPresentCount.textContent = statusCounts["Present"] || 0;
            statAbsentCount.textContent = statusCounts["Absent"] || 0;
            statLeaveCount.textContent = statusCounts["On Leave"] || 0;
            statHalfDayCount.textContent = statusCounts["Half Day"] || 0;

            statsDashboard.style.display = "block";
        }

        // --- Data Transformation ---
        function pivotDataToGridFormat(records) {
            const employeeData = {};
            records.forEach((record) => {
                if (!record.employee || !record.attendance_date) return;
                const day = new Date(record.attendance_date).getUTCDate();
                if (!employeeData[record.employee]) {
                    employeeData[record.employee] = {
                        "Employee Code": record.employee,
                        "Employee Name":
                            record.employee_name || record.employee,
                    };
                }
                employeeData[record.employee][day] = record.status;
            });
            return { gridData: Object.values(employeeData) };
        }

        function unpivotGridToRecords(gridData, year, month) {
            const records = [];
            gridData.forEach((employeeRow) => {
                const empCode = employeeRow["Employee Code"];
                if (!empCode) return;
                for (const [key, value] of Object.entries(employeeRow)) {
                    if (!isNaN(key) && value) {
                        const day = parseInt(key, 10);
                        const date = `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
                        records.push({
                            employee: empCode,
                            employee_name: employeeRow["Employee Name"],
                            attendance_date: date,
                            status: value,
                        });
                    }
                }
            });
            return records;
        }

        // --- Main Data Loading & Grid Rendering ---
        async function checkStatusAndLoad() {
            try {
                const res = await apiCall(
                    `/api/v1/conversions/${jobId}/status`,
                );
                if (!res.ok) throw new Error("Job not found or access denied.");
                const job = await res.json();
                currentJobData = job;

                elTitle.textContent = job.original_filename;
                elSubtitle.textContent = `Job for ${job.target_doctype} | Created: ${new Date(job.created_at).toLocaleString()}`;
                elBadge.textContent = job.status;

                // Display submission errors if present
                if (
                    job.status === "SUBMISSION_FAILED" &&
                    job.error_log &&
                    job.error_log.details
                ) {
                    errorPanel.style.display = "block";
                    errorSummary.textContent =
                        job.error_log.summary ||
                        "Some records failed to submit.";
                    errorDetails.innerHTML = job.error_log.details
                        .map(
                            (err) =>
                                `<div style="border-bottom: 1px solid #fee2e2; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                        <strong>Record #${err.record_index + 1} (Emp: ${err.record_data.employee}):</strong>
                        <p style="color: #991b1b; margin-left: 1rem;">${err.error}</p>
                    </div>`,
                        )
                        .join("");
                } else {
                    errorPanel.style.display = "none";
                }

                if (
                    job.status === "AWAITING_VALIDATION" ||
                    job.status === "SUBMISSION_FAILED"
                ) {
                    if (
                        job.target_doctype.toLowerCase() === "attendance" &&
                        job.attendance_year &&
                        job.attendance_month
                    ) {
                        await loadProcessedGridAsMatrix(
                            job.attendance_year,
                            job.attendance_month,
                        );
                    } else {
                        await loadProcessedGridAsList();
                    }
                    elActions.style.display = "flex";
                } else if (
                    job.status === "PROCESSING" ||
                    job.status === "UPLOADED"
                ) {
                    gridProcessedContainer.innerHTML =
                        '<div style="padding:40px; text-align:center;">Processing... Page will refresh in 5s</div>';
                    setTimeout(() => window.location.reload(), 5000);
                } else {
                    gridProcessedContainer.innerHTML = `<div style="padding:40px; text-align:center;">Job is ${job.status}. No data to display or edit.</div>`;
                }
            } catch (e) {
                console.error("Error loading job:", e);
                gridProcessedContainer.innerHTML = `<div style="padding:40px; text-align:center; color:red;">Error: ${e.message}</div>`;
            }
        }

        async function loadProcessedGridAsMatrix(year, month) {
            try {
                const res = await apiCall(
                    `/api/v1/conversions/${jobId}/data/processed`,
                );
                if (!res.ok) throw new Error("Processed data file not found.");
                const records = await res.json();

                updateStatsDashboard(records);

                if (records.length === 0) {
                    gridProcessedContainer.innerHTML =
                        '<div style="padding:40px; text-align:center; color:#666;">0 Records Processed. Check template configuration.</div>';
                    return;
                }

                const { gridData } = pivotDataToGridFormat(records);
                const daysInMonth = new Date(year, month, 0).getDate();
                const dayColumns = Array.from(
                    { length: daysInMonth },
                    (_, i) => ({
                        data: `${i + 1}`,
                        title: `${i + 1}`,
                        renderer: statusRenderer,
                    }),
                );

                const columns = [
                    {
                        data: "Employee Code",
                        title: "Employee Code",
                        readOnly: true,
                        width: 120,
                    },
                    {
                        data: "Employee Name",
                        title: "Employee Name",
                        readOnly: true,
                        width: 200,
                    },
                    ...dayColumns.map((col) => ({
                        ...col,
                        type: "dropdown",
                        width: 60,
                        source: [
                            "",
                            "Present",
                            "Absent",
                            "On Leave",
                            "Half Day",
                        ],
                    })),
                ];

                gridProcessedContainer.innerHTML = "";
                hotProcessed = new Handsontable(gridProcessedContainer, {
                    data: gridData,
                    columns: columns,
                    rowHeaders: true,
                    colHeaders: true,
                    licenseKey: "non-commercial-and-evaluation",
                    height: "100%",
                    width: "100%",
                    fixedColumnsLeft: 2,
                    manualColumnResize: true,
                    dropdownMenu: true,
                    filters: true,
                    columnSorting: true,
                    search: true,
                    contextMenu: true,
                });
            } catch (e) {
                console.error("Error loading matrix grid:", e);
                gridProcessedContainer.innerHTML = `<div style="padding:20px; color:red;">Load Error: ${e.message}</div>`;
            }
        }

        async function loadProcessedGridAsList() {
            try {
                const res = await apiCall(
                    `/api/v1/conversions/${jobId}/data/processed`,
                );
                if (!res.ok) throw new Error("Processed data file not found.");
                const data = await res.json();

                updateStatsDashboard(data);

                if (data.length === 0) {
                    gridProcessedContainer.innerHTML =
                        '<div style="padding:40px; text-align:center; color:#666;">0 Records Processed.</div>';
                    return;
                }

                gridProcessedContainer.innerHTML = "";
                const columns = Object.keys(data[0]).map((key) => {
                    const col = { data: key, title: key };
                    if (key.toLowerCase() === "status") {
                        col.renderer = statusRenderer;
                    }
                    return col;
                });

                hotProcessed = new Handsontable(gridProcessedContainer, {
                    data,
                    columns,
                    rowHeaders: true,
                    colHeaders: true,
                    licenseKey: "non-commercial-and-evaluation",
                    height: "100%",
                    width: "100%",
                    stretchH: "all",
                    minSpareRows: 1,
                    dropdownMenu: true,
                    filters: true,
                    columnSorting: true,
                    search: true,
                    contextMenu: true,
                });
            } catch (e) {
                console.error("Error loading list grid:", e);
                gridProcessedContainer.innerHTML = `<div style="padding:20px; color:red;">Load Error: ${e.message}</div>`;
            }
        }

        async function loadRawGrid() {
            try {
                const res = await apiCall(
                    `/api/v1/conversions/${jobId}/data/raw`,
                );
                if (!res.ok) throw new Error("Raw data file not found.");
                const data = await res.json();

                if (data.length === 0) {
                    gridRawContainer.innerHTML =
                        '<div style="padding:40px; text-align:center; color:#666;">No raw data available.</div>';
                    return;
                }

                gridRawContainer.innerHTML = "";
                const columns = Object.keys(data[0]).map((key) => {
                    const col = { data: key, title: key };
                    if (key.toLowerCase() === "status") {
                        col.renderer = statusRenderer;
                    }
                    return col;
                });

                hotRaw = new Handsontable(gridRawContainer, {
                    data,
                    columns,
                    rowHeaders: true,
                    colHeaders: true,
                    licenseKey: "non-commercial-and-evaluation",
                    height: "100%",
                    width: "100%",
                    readOnly: true,
                    stretchH: "all",
                    dropdownMenu: true,
                    filters: true,
                    columnSorting: true,
                    search: true,
                });
            } catch (e) {
                console.error("Error loading raw grid:", e);
                gridRawContainer.innerHTML = `<div style="padding:20px; color:red;">Load Error: ${e.message}</div>`;
            }
        }

        btnSubmit.addEventListener("click", async () => {
            if (!hotProcessed) {
                alert("No data loaded to submit");
                return;
            }

            if (!currentJobData) {
                alert("Job data not loaded. Please refresh the page.");
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.textContent = "Processing...";

            try {
                const editedData = hotProcessed
                    .getSourceData()
                    .filter((row) =>
                        Object.values(row).some(
                            (val) => val !== null && val !== "",
                        ),
                    );

                let recordsToSubmit;
                if (
                    currentJobData.target_doctype.toLowerCase() ===
                        "attendance" &&
                    currentJobData.attendance_year &&
                    currentJobData.attendance_month
                ) {
                    recordsToSubmit = unpivotGridToRecords(
                        editedData,
                        currentJobData.attendance_year,
                        currentJobData.attendance_month,
                    );
                } else {
                    recordsToSubmit = editedData;
                }

                if (recordsToSubmit.length === 0) {
                    alert("No records to submit. Please add data to the grid.");
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = "Submit Records to ERPNext";
                    return;
                }

                const res = await fetch(`/api/v1/conversions/${jobId}/submit`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ data: recordsToSubmit }),
                });

                if (res.ok) {
                    alert(
                        "Submission task has been started. The job status will update shortly.",
                    );
                    window.location.reload();
                } else {
                    const err = await res.json();
                    throw new Error(err.detail || "Submission failed.");
                }
            } catch (e) {
                console.error("Submission error:", e);
                alert("Error: " + e.message);
                btnSubmit.disabled = false;
                btnSubmit.textContent = "Submit Records to ERPNext";
            }
        });

        // Initial load
        checkStatusAndLoad();
    });
</script>
{% endblock %}
