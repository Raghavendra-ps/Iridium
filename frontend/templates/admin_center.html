{% extends "dashboard_base.html" %}
{% block title %}Admin Center - User Management{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">User Management</h1>
    <p style="color: var(--color-text-muted); margin-bottom: 1.5rem;">
        Manage roles, system status, and organizational assignments for all users.
    </p>
    <div id="user-table-container">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="border-bottom: 2px solid var(--color-border);">
                    <th style="padding: 12px 8px;">User</th>
                    <th style="padding: 12px 8px;">Role</th>
                    <th style="padding: 12px 8px;">Organisation</th>
                    <th style="padding: 12px 8px;">Status</th>
                    <th style="padding: 12px 8px; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="user-list-body">
                <!-- JS Populated -->
            </tbody>
        </table>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <h2>Edit User & Permissions</h2>
        <form id="editUserForm">
            <input type="hidden" id="edit-user-id">
            <div class="form-group">
                <label>System Role</label>
                <select id="edit-role" name="role">
                    <option value="superadmin">SuperAdmin (Full Access)</option>
                    <option value="manager">Manager (Operations)</option>
                    <option value="client">Client (Sheets Only)</option>
                    <option value="employee">Employee (View Only)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Account Status</label>
                <select id="edit-status" name="status">
                    <option value="pending">Pending Approval</option>
                    <option value="active">Active / Approved</option>
                </select>
            </div>
            <div class="form-group">
                <label>Assigned Organisation</label>
                <select id="edit-org" name="organization_id">
                    <option value="">-- No Organisation (Unassigned) --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Login Access</label>
                <select id="edit-is-active" name="is_active">
                    <option value="true">Enabled</option>
                    <option value="false">Suspended / Disabled</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeEditModal()" class="btn">Cancel</button>
                <button type="submit" class="btn" style="background: var(--color-accent); color: white;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #475569; }
    .form-group select { width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 8px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; }
    .status-badge { padding: 4px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-active { background: #dcfce7; color: #166534; }
</style>
{% endblock %}

{% block scripts %}
<script>
let allUsers = [];
let allOrgs = [];

function onPageLoad(token) {
    const apiCall = (url, options = {}) => fetch(url, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, ...options });

    async function loadData() {
        // Fetch Users and Orgs in parallel
        const [uRes, oRes] = await Promise.all([
            apiCall('/api/v1/admin/users'),
            apiCall('/api/v1/organizations/')
        ]);
        allUsers = await uRes.json();
        allOrgs = await oRes.json();
        
        renderTable();
        populateOrgDropdown();
    }

    function populateOrgDropdown() {
        const select = document.getElementById('edit-org');
        select.innerHTML = '<option value="">-- No Organisation --</option>';
        allOrgs.forEach(org => {
            const opt = new Option(org.name, org.id);
            select.add(opt);
        });
    }

    function renderTable() {
        const body = document.getElementById('user-list-body');
        body.innerHTML = allUsers.map(user => `
            <tr style="border-bottom: 1px solid var(--color-border);">
                <td style="padding: 12px 8px;"><strong>${user.email}</strong></td>
                <td style="padding: 12px 8px;"><small>${user.role}</small></td>
                <td style="padding: 12px 8px;">${user.organization_id ? getOrgName(user.organization_id) : '<span style="color:#cbd5e1">None</span>'}</td>
                <td style="padding: 12px 8px;"><span class="status-badge status-${user.status}">${user.status}</span></td>
                <td style="padding: 12px 8px; text-align: right;">
                    <button class="btn" onclick="openEditModal(${user.id})">Edit</button>
                </td>
            </tr>
        `).join('');
    }

    function getOrgName(id) {
        const org = allOrgs.find(o => o.id === id);
        return org ? org.name : 'Unknown';
    }

    window.openEditModal = (id) => {
        const user = allUsers.find(u => u.id === id);
        document.getElementById('edit-user-id').value = user.id;
        document.getElementById('edit-role').value = user.role;
        document.getElementById('edit-status').value = user.status;
        document.getElementById('edit-org').value = user.organization_id || "";
        document.getElementById('edit-is-active').value = user.is_active.toString();
        document.getElementById('editUserModal').style.display = 'flex';
    };

    window.closeEditModal = () => document.getElementById('editUserModal').style.display = 'none';

    document.getElementById('editUserForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-user-id').value;
        const payload = {
            role: document.getElementById('edit-role').value,
            status: document.getElementById('edit-status').value,
            organization_id: document.getElementById('edit-org').value ? parseInt(document.getElementById('edit-org').value) : null,
            is_active: document.getElementById('edit-is-active').value === 'true'
        };

        const res = await apiCall(`/api/v1/admin/users/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
        if (res.ok) { closeEditModal(); loadData(); }
    };

    loadData();
}
</script>
{% endblock %}