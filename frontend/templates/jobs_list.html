{% extends "dashboard_base.html" %}

{% block title %}My Jobs - Iridium{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 class="card-title" style="margin-bottom: 0;">My Conversion Jobs</h1>
        <a href="/upload" class="btn" style="background-color: var(--color-accent); color: white;">+ New Conversion</a>
    </div>

    <table style="width: 100%; border-collapse: collapse; text-align: left;">
        <thead>
            <tr style="border-bottom: 1px solid var(--color-border);">
                <th style="padding: 12px 0;">Filename</th>
                <th style="padding: 12px 0;">Doctype</th>
                <th style="padding: 12px 0;">Submitted</th>
                <th style="padding: 12px 0;">Status</th>
                <th style="padding: 12px 0;"></th>
            </tr>
        </thead>
        <tbody id="jobs-table-body">
            <!-- JS will populate this -->
            <tr><td colspan="5" style="padding: 48px 0; text-align: center; color: var(--color-text-muted);">Loading jobs...</td></tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
// This script block runs only on the Jobs List page
function onPageLoad(token) {
    const tableBody = document.getElementById('jobs-table-body');

    const apiCall = async (url, options = {}) => {
        const defaultOptions = {
            headers: { 'Authorization': `Bearer ${token}` }
        };
        return await fetch(url, { ...defaultOptions, ...options });
    };

    async function fetchAndRenderJobs() {
        try {
            const response = await apiCall('/api/v1/conversions/');
            if (!response.ok) throw new Error('Failed to fetch jobs');

            const jobs = await response.json();
            tableBody.innerHTML = '';

            if (jobs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" style="padding: 48px 0; text-align: center; color: var(--color-text-muted);">You haven't submitted any jobs yet.</td></tr>`;
            } else {
                jobs.forEach(job => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--color-border)';
                    row.innerHTML = `
                        <td style="padding: 16px 0;">${job.original_filename}</td>
                        <td style="padding: 16px 0;">${job.target_doctype}</td>
                        <td style="padding: 16px 0;">${job.created_at}</td>
                        <td style="padding: 16px 0;">
                            <span style="background: #eee; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 500;">
                                ${job.status}
                            </span>
                        </td>
                        <td style="padding: 16px 0; text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <a href="/jobs/${job.id}" class="btn">View</a>
                            <button class="btn btn-danger" data-job-id="${job.id}">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        } catch(e) {
            tableBody.innerHTML = `<tr><td colspan="5" style="padding: 48px 0; text-align: center; color: red;">Error loading jobs.</td></tr>`;
        }
    }

    tableBody.addEventListener('click', async (event) => {
        const target = event.target;
        if (target.tagName === 'BUTTON' && target.dataset.jobId) {
            const jobId = target.dataset.jobId;
            if (confirm(`Are you sure you want to permanently delete job #${jobId}?`)) {
                target.textContent = 'Deleting...';
                target.disabled = true;
                try {
                    const response = await apiCall(`/api/v1/conversions/${jobId}`, { method: 'DELETE' });
                    if (response.status === 204) {
                        // On success, simply remove the row from the table
                        target.closest('tr').remove();
                    } else {
                        const errorData = await response.json();
                        alert(`Failed to delete job: ${errorData.detail}`);
                        target.textContent = 'Delete';
                        target.disabled = false;
                    }
                } catch (e) {
                    alert('An error occurred while trying to delete the job.');
                    target.textContent = 'Delete';
                    target.disabled = false;
                }
            }
        }
    });

    // Initial load
    fetchAndRenderJobs();
}
</script>
{% endblock %}
